# auth.py - Sistema de Autentica√ß√£o Seguro
"""
M√≥dulo de autentica√ß√£o com bcrypt e boas pr√°ticas de seguran√ßa
"""

import bcrypt
from datetime import datetime, timezone, timedelta
from db.mongo import db

# Collection de usu√°rios
collect_users = db['usuarios']

# Fuso hor√°rio de Bras√≠lia
brt = timezone(timedelta(hours=-3))


def hash_senha(senha):
    """
    Gera hash seguro da senha usando bcrypt

    Args:
        senha (str): Senha em texto plano

    Returns:
        bytes: Hash da senha
    """
    salt = bcrypt.gensalt(rounds=12)  # 12 rounds √© um bom balan√ßo seguran√ßa/performance
    return bcrypt.hashpw(senha.encode('utf-8'), salt)


def verificar_senha(senha, hash_armazenado):
    """
    Verifica se a senha corresponde ao hash armazenado

    Args:
        senha (str): Senha em texto plano
        hash_armazenado (bytes ou str): Hash armazenado no banco

    Returns:
        bool: True se a senha √© v√°lida, False caso contr√°rio
    """
    try:
        # Converte para bytes se necess√°rio
        if isinstance(hash_armazenado, str):
            hash_armazenado = hash_armazenado.encode('utf-8')

        return bcrypt.checkpw(senha.encode('utf-8'), hash_armazenado)
    except Exception as e:
        print(f'‚ùå Erro ao verificar senha: {str(e)}')
        return False


def criar_usuario(usuario, senha, nome_completo, email, role='user'):
    """
    Cria um novo usu√°rio no sistema

    Args:
        usuario (str): Nome de usu√°rio (√∫nico)
        senha (str): Senha em texto plano
        nome_completo (str): Nome completo do usu√°rio
        email (str): Email do usu√°rio
        role (str): Papel do usu√°rio (admin, user, etc)

    Returns:
        dict: Resultado da opera√ß√£o
    """
    # Verifica se usu√°rio j√° existe
    if collect_users.find_one({'usuario': usuario}):
        return {
            'success': False,
            'message': 'Usu√°rio j√° existe'
        }

    # Verifica se email j√° existe
    if collect_users.find_one({'email': email}):
        return {
            'success': False,
            'message': 'Email j√° cadastrado'
        }

    # Cria hash da senha
    senha_hash = hash_senha(senha)

    # Cria documento do usu√°rio
    novo_usuario = {
        'usuario': usuario,
        'senha': senha_hash,
        'nome_completo': nome_completo,
        'email': email,
        'role': role,
        'ativo': True,
        'data_criacao': datetime.now(brt).strftime('%d/%m/%Y %H:%M:%S'),
        'ultimo_login': None,
        'tentativas_login': 0,
        'bloqueado_ate': None
    }

    try:
        result = collect_users.insert_one(novo_usuario)
        print(f'‚úÖ Usu√°rio criado: {usuario}')
        return {
            'success': True,
            'message': 'Usu√°rio criado com sucesso',
            'user_id': str(result.inserted_id)
        }
    except Exception as e:
        print(f'‚ùå Erro ao criar usu√°rio: {str(e)}')
        return {
            'success': False,
            'message': f'Erro ao criar usu√°rio: {str(e)}'
        }


def autenticar_usuario(usuario, senha):
    """
    Autentica um usu√°rio

    Args:
        usuario (str): Nome de usu√°rio
        senha (str): Senha em texto plano

    Returns:
        dict: Resultado da autentica√ß√£o
    """
    # Busca usu√°rio
    user = collect_users.find_one({'usuario': usuario})

    if not user:
        print(f'‚ö†Ô∏è Tentativa de login com usu√°rio inexistente: {usuario}')
        return {
            'success': False,
            'message': 'Usu√°rio ou senha inv√°lidos'  # N√£o especifica qual est√° errado
        }

    # Verifica se conta est√° ativa
    if not user.get('ativo', True):
        return {
            'success': False,
            'message': 'Conta desativada. Contate o administrador.'
        }

    # Verifica se conta est√° bloqueada
    bloqueado_ate = user.get('bloqueado_ate')
    if bloqueado_ate:
        if isinstance(bloqueado_ate, str):
            # Se estiver como string, considera como ainda bloqueado
            return {
                'success': False,
                'message': 'Conta temporariamente bloqueada. Tente novamente mais tarde.'
            }

    # Verifica senha
    if verificar_senha(senha, user['senha']):
        # Senha correta - Reseta tentativas e atualiza √∫ltimo login
        collect_users.update_one(
            {'_id': user['_id']},
            {
                '$set': {
                    'ultimo_login': datetime.now(brt).strftime('%d/%m/%Y %H:%M:%S'),
                    'tentativas_login': 0,
                    'bloqueado_ate': None
                }
            }
        )

        print(f'‚úÖ Login bem-sucedido: {usuario}')
        return {
            'success': True,
            'message': 'Login realizado com sucesso',
            'user': {
                'id': str(user['_id']),
                'usuario': user['usuario'],
                'nome_completo': user['nome_completo'],
                'email': user['email'],
                'role': user.get('role', 'user')
            }
        }
    else:
        # Senha incorreta - Incrementa tentativas
        tentativas = user.get('tentativas_login', 0) + 1

        update_data = {
            'tentativas_login': tentativas
        }

        # Bloqueia ap√≥s 5 tentativas
        if tentativas >= 5:
            # Bloqueia por 15 minutos
            bloqueio = datetime.now(brt) + timedelta(minutes=15)
            update_data['bloqueado_ate'] = bloqueio.strftime('%d/%m/%Y %H:%M:%S')
            print(f'‚ö†Ô∏è Conta bloqueada por m√∫ltiplas tentativas: {usuario}')

        collect_users.update_one(
            {'_id': user['_id']},
            {'$set': update_data}
        )

        print(f'‚ùå Tentativa de login falhou: {usuario} (tentativa {tentativas})')

        mensagem = 'Usu√°rio ou senha inv√°lidos'
        if tentativas >= 5:
            mensagem = 'Conta bloqueada por 15 minutos devido a m√∫ltiplas tentativas falhas'

        return {
            'success': False,
            'message': mensagem,
            'tentativas': tentativas
        }


def alterar_senha(usuario, senha_antiga, senha_nova):
    """
    Altera a senha de um usu√°rio

    Args:
        usuario (str): Nome de usu√°rio
        senha_antiga (str): Senha atual
        senha_nova (str): Nova senha

    Returns:
        dict: Resultado da opera√ß√£o
    """
    # Busca usu√°rio
    user = collect_users.find_one({'usuario': usuario})

    if not user:
        return {
            'success': False,
            'message': 'Usu√°rio n√£o encontrado'
        }

    # Verifica senha antiga
    if not verificar_senha(senha_antiga, user['senha']):
        return {
            'success': False,
            'message': 'Senha atual incorreta'
        }

    # Valida nova senha
    if len(senha_nova) < 6:
        return {
            'success': False,
            'message': 'A nova senha deve ter no m√≠nimo 6 caracteres'
        }

    # Gera novo hash
    novo_hash = hash_senha(senha_nova)

    # Atualiza no banco
    collect_users.update_one(
        {'_id': user['_id']},
        {'$set': {'senha': novo_hash}}
    )

    print(f'‚úÖ Senha alterada: {usuario}')
    return {
        'success': True,
        'message': 'Senha alterada com sucesso'
    }


def resetar_senha_admin(usuario, senha_nova):
    """
    Admin reseta senha de usu√°rio (sem precisar da senha antiga)

    Args:
        usuario (str): Nome de usu√°rio
        senha_nova (str): Nova senha

    Returns:
        dict: Resultado da opera√ß√£o
    """
    user = collect_users.find_one({'usuario': usuario})

    if not user:
        return {
            'success': False,
            'message': 'Usu√°rio n√£o encontrado'
        }

    # Gera novo hash
    novo_hash = hash_senha(senha_nova)

    # Atualiza no banco e reseta tentativas
    collect_users.update_one(
        {'_id': user['_id']},
        {
            '$set': {
                'senha': novo_hash,
                'tentativas_login': 0,
                'bloqueado_ate': None
            }
        }
    )

    print(f'‚úÖ Senha resetada por admin: {usuario}')
    return {
        'success': True,
        'message': 'Senha resetada com sucesso'
    }


def listar_usuarios():
    """
    Lista todos os usu√°rios (sem as senhas)

    Returns:
        list: Lista de usu√°rios
    """
    usuarios = collect_users.find(
        {},
        {
            'senha': 0  # N√£o retorna a senha
        }
    )

    users_list = []
    for user in usuarios:
        user['_id'] = str(user['_id'])
        users_list.append(user)

    return users_list


def desativar_usuario(usuario):
    """
    Desativa um usu√°rio (n√£o deleta, apenas desativa)

    Args:
        usuario (str): Nome de usu√°rio

    Returns:
        dict: Resultado da opera√ß√£o
    """
    result = collect_users.update_one(
        {'usuario': usuario},
        {'$set': {'ativo': False}}
    )

    if result.modified_count > 0:
        print(f'‚úÖ Usu√°rio desativado: {usuario}')
        return {
            'success': True,
            'message': 'Usu√°rio desativado com sucesso'
        }
    else:
        return {
            'success': False,
            'message': 'Usu√°rio n√£o encontrado'
        }


# ========================================
# SCRIPT DE INICIALIZA√á√ÉO
# ========================================

def inicializar_usuarios():
    """
    Cria usu√°rio admin padr√£o se n√£o existir
    """
    admin_existente = collect_users.find_one({'usuario': 'admin'})

    if not admin_existente:
        print('üìù Criando usu√°rio admin padr√£o...')
        resultado = criar_usuario(
            usuario='admin',
            senha='Admin@123',  # ALTERE ESSA SENHA DEPOIS!
            nome_completo='Administrador',
            email='admin@evolutecode.com',
            role='admin'
        )

        if resultado['success']:
            print('‚úÖ Usu√°rio admin criado!')
            print('‚ö†Ô∏è  IMPORTANTE: Altere a senha padr√£o imediatamente!')
            print('   Usu√°rio: admin')
            print('   Senha: Admin@123')
        else:
            print(f'‚ùå Erro ao criar admin: {resultado["message"]}')
    else:
        print('‚úÖ Usu√°rio admin j√° existe')


if __name__ == '__main__':
    # Testa o sistema
    print('üß™ Testando sistema de autentica√ß√£o...')

    # Inicializa usu√°rios
    inicializar_usuarios()

    # Teste de autentica√ß√£o
    print('\nüîê Testando autentica√ß√£o...')
    resultado = autenticar_usuario('admin', 'Admin@123')
    print(f'Resultado: {resultado}')
    
